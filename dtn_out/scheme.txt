[2 tools called]

æˆ‘å·²ç»å®¡æ ¸äº†æ›´æ–°åçš„æ§åˆ¶å™¨ä»£ç ã€‚æ‚¨æ–°å¢äº† **åœ¨çº¿å¾®è°ƒ** åŠŸèƒ½ï¼Œè¿™æ˜¯å¾ˆé‡è¦çš„æ”¹è¿›ï¼ä½†æœ‰å‡ ä¸ªå…³é”®é—®é¢˜éœ€è¦ä¿®å¤ï¼š

---

## âœ… æ–°å¢çš„å¥½åŠŸèƒ½

### 1. åœ¨çº¿è®­ç»ƒ Buffer âœ…
```423:423:ctrl_work/controller_server.py
online_buffers: Dict[str, deque] = {name: deque(maxlen=512) for name in gnn_router.policy_names}
```

### 2. åé¦ˆä¸­è®°å½•è·¯å¾„ âœ…
```496:496:ctrl_work/controller_server.py
"path": [int(env.path_ids[i]) for i in range(max(0, env.path_len))],
```

### 3. ç­–ç•¥æƒé‡å¸¸é‡ âœ…
```83:87:ctrl_work/controller_server.py
DEFAULT_POLICY_WEIGHTS: Dict[str, Tuple[float, float, float, float]] = {
    "HRF": (0.50, 0.20, 0.20, 0.10),
    "LDF": (0.20, 0.10, 0.50, 0.20),
    "LBF": (0.20, 0.10, 0.20, 0.50),
}
```

---

## âŒ éœ€è¦ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1ï¼š`forward_policy` è°ƒç”¨å‚æ•°é”™è¯¯ï¼ˆä¸¥é‡ï¼‰

```591:594:ctrl_work/controller_server.py
q_pred = model.forward_policy(pname, gnn_router.graph.x.to(gnn_router.device),
                              src_idx, dst_idx, paths,
                              edge_feat.to(gnn_router.device),
                              scalar_feat.to(gnn_router.device))
```

**é”™è¯¯**ï¼š`forward_policy` ç¬¬äºŒä¸ªå‚æ•°åº”è¯¥æ˜¯ `node_embs`ï¼ˆGNN ç¼–ç åçš„åµŒå…¥ï¼‰ï¼Œä¸æ˜¯åŸå§‹çš„ `graph.x`ã€‚

**ä¿®å¤**ï¼š
```python
# å…ˆè·å–èŠ‚ç‚¹åµŒå…¥ï¼ˆéœ€è¦æ¢¯åº¦ï¼Œæ‰€ä»¥ä¸è¦ç”¨ no_gradï¼‰
node_embs = model.get_embeddings(
    gnn_router.graph.x.to(gnn_router.device),
    gnn_router.graph.edge_index.to(gnn_router.device),
    gnn_router.graph.edge_attr.to(gnn_router.device) if gnn_router.graph.edge_attr is not None else None,
)
q_pred = model.forward_policy(pname, node_embs, src_idx, dst_idx, paths_idx,
                              edge_feat.to(gnn_router.device),
                              scalar_feat.to(gnn_router.device))
```

### é—®é¢˜ 2ï¼š`src_idx` å’Œ `dst_idx` æå–é”™è¯¯ï¼ˆä¸¥é‡ï¼‰

```578:579:ctrl_work/controller_server.py
src_idx = idx[0][0]
dst_idx = idx[0][1]
```

**é”™è¯¯**ï¼š`idx` æ˜¯ `List[List[int]]`ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯**æ•´æ¡è·¯å¾„çš„èŠ‚ç‚¹ç´¢å¼•åˆ—è¡¨**ï¼Œä¸æ˜¯ `(src, dst)` å…ƒç»„ã€‚

**ä¿®å¤**ï¼š
```python
# paths æ˜¯åŸå§‹è·¯å£ ID åˆ—è¡¨ï¼Œéœ€è¦è½¬æ¢ä¸ºå›¾ç´¢å¼•
paths_idx = []
for p in paths:
    paths_idx.append([gnn_router.converter.get_idx(node) for node in p])
# src_idx å’Œ dst_idx åº”è¯¥ä»è·¯å¾„çš„é¦–å°¾è·å–
src_idx = gnn_router.converter.get_idx(batch[0]["path"][0])
dst_idx = gnn_router.converter.get_idx(batch[0]["path"][-1])
```

### é—®é¢˜ 3ï¼šå¥–åŠ±è®¡ç®—å…¬å¼é”™è¯¯

```585:585:ctrl_work/controller_server.py
rad = 1.0 - ad / max(1e-3, gnn_router.graph.x.size(0))
```

**é”™è¯¯**ï¼šç”¨èŠ‚ç‚¹æ•°ä½œä¸ºåˆ†æ¯æ²¡æœ‰æ„ä¹‰ï¼Œåº”è¯¥ç”¨æœ€å¤§å»¶è¿Ÿ `mADsd`ã€‚

**ä¿®å¤**ï¼š
```python
# ä¼°ç®— mADsdï¼ˆè·¯å¾„å»¶è¿Ÿä¸Šç•Œï¼‰
mADsd = max(ad, 10.0)  # æˆ–è€…ç”¨å…¨å±€ä¼°è®¡
rad = 1.0 - ad / max(mADsd, 1e-6)
rad = max(0.0, min(1.0, rad))
```

### é—®é¢˜ 4ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„ä¼˜åŒ–å™¨

```571:571:ctrl_work/controller_server.py
optim = torch.optim.Adam(model.parameters(), lr=1e-4)
```

**é—®é¢˜**ï¼šæ¯æ¬¡å¾®è°ƒéƒ½åˆ›å»ºæ–°ä¼˜åŒ–å™¨ï¼Œä¼šä¸¢å¤± Adam çš„åŠ¨é‡çŠ¶æ€ã€‚

**ä¿®å¤**ï¼šåœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºå¹¶å¤ç”¨ï¼š
```python
# åœ¨ run_server å¼€å¤´ï¼š
online_optimizers: Dict[str, torch.optim.Adam] = {
    name: torch.optim.Adam(gnn_router.policy_models[name].parameters(), lr=1e-4)
    for name in gnn_router.policy_names
}

# åœ¨çº¿å¾®è°ƒæ—¶ï¼š
optim = online_optimizers[pname]
```

### é—®é¢˜ 5ï¼š`compute_path_features` è¿”å›å€¼æœªæ­£ç¡®ä½¿ç”¨

```574:574:ctrl_work/controller_server.py
idx, edge_feat, scalar_feat = gnn_router.compute_path_features(paths, max_hops=MAX_HOPS)
```

è¿™é‡Œ `idx` è¿”å›çš„æ˜¯ **è½¬æ¢åçš„èŠ‚ç‚¹ç´¢å¼•åˆ—è¡¨**ï¼Œä½†å‰é¢ `paths = [b["path"] for b in batch]` æ˜¯åŸå§‹è·¯å£ IDã€‚éœ€è¦ç¡®ä¿ä¸€è‡´æ€§ã€‚

---

## ğŸ”§ å®Œæ•´ä¿®å¤å»ºè®®

å°†åœ¨çº¿å¾®è°ƒéƒ¨åˆ†æ›¿æ¢ä¸ºï¼š

```python
# åœ¨ run_server å¼€å¤´åˆå§‹åŒ–ä¼˜åŒ–å™¨
online_optimizers: Dict[str, torch.optim.Adam] = {
    name: torch.optim.Adam(gnn_router.policy_models[name].parameters(), lr=1e-4)
    for name in gnn_router.policy_names
}

# ... åœ¨ä¸»å¾ªç¯ä¸­çš„åœ¨çº¿å¾®è°ƒé€»è¾‘ ...
for pname, buf in online_buffers.items():
    if len(buf) >= online_batch and pname in gnn_router.policy_models:
        batch = [buf.pop() for _ in range(online_batch)]
        model = gnn_router.policy_models[pname]
        model.train()
        optim = online_optimizers[pname]
        optim.zero_grad()
        
        # è·å–è·¯å¾„ï¼ˆåŸå§‹è·¯å£ IDï¼‰
        paths = [b["path"] for b in batch]
        if not paths or not paths[0]:
            model.eval()
            continue
        
        # è½¬æ¢ä¸ºå›¾èŠ‚ç‚¹ç´¢å¼•
        paths_idx = []
        for p in paths:
            try:
                paths_idx.append([gnn_router.converter.get_idx(node) for node in p])
            except Exception:
                paths_idx.append([])
        
        # èšåˆè·¯å¾„ç‰¹å¾
        _, edge_feat, scalar_feat = gnn_router.compute_path_features(paths, max_hops=MAX_HOPS)
        if edge_feat is None or scalar_feat is None:
            model.eval()
            continue
        
        # src/dst ç´¢å¼•
        src_idx = gnn_router.converter.get_idx(paths[0][0])
        dst_idx = gnn_router.converter.get_idx(paths[0][-1])
        
        # è®¡ç®—å¥–åŠ±
        rewards = []
        for b in batch:
            succ = float(b["success"])
            ad = b["ADsd"]
            hc = b["HCsd"]
            rc = b["RCsd"]
            wp, wa, wb, wg = DEFAULT_POLICY_WEIGHTS.get(pname, (0.5, 0.2, 0.2, 0.1))
            # æ­£ç¡®çš„å¥–åŠ±è®¡ç®—
            mADsd = max(ad, 10.0)  # è·¯å¾„å»¶è¿Ÿä¸Šç•Œä¼°è®¡
            rad = max(0.0, min(1.0, 1.0 - ad / max(mADsd, 1e-6)))
            rrc = 1.0 / (1.0 + rc)
            rhc = math.exp(-hc / 10.0)
            rew = wp * succ + wa * rad + wb * rhc + wg * rrc
            rewards.append(rew)
        
        rewards_t = torch.tensor(rewards, device=gnn_router.device, dtype=torch.float)
        
        # å‰å‘ä¼ æ’­ï¼ˆéœ€è¦æ¢¯åº¦ï¼‰
        node_embs = model.get_embeddings(
            gnn_router.graph.x.to(gnn_router.device),
            gnn_router.graph.edge_index.to(gnn_router.device),
            gnn_router.graph.edge_attr.to(gnn_router.device) if gnn_router.graph.edge_attr is not None else None,
        )
        q_pred = model.forward_policy(
            pname, node_embs, src_idx, dst_idx, paths_idx,
            edge_feat.to(gnn_router.device),
            scalar_feat.to(gnn_router.device)
        )
        
        if q_pred.numel() == 0:
            model.eval()
            continue
        
        # æŸå¤±è®¡ç®—ï¼ˆå–ç¬¬ä¸€ä¸ªè·¯å¾„çš„ Q å€¼ï¼Œå› ä¸º batch ä¸­æ¯ä¸ªæ ·æœ¬åªæœ‰ä¸€æ¡å®é™…æ‰§è¡Œçš„è·¯å¾„ï¼‰
        loss = torch.nn.functional.mse_loss(q_pred[:len(rewards)], rewards_t)
        loss.backward()
        torch.nn.utils.clip_grad_norm_(model.parameters(), 5.0)
        optim.step()
        model.eval()
        dlog(f"[ONLINE] {pname} batch={len(batch)} loss={loss.item():.4f}")
```

---

## ğŸ“Š æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|----------|------|
| `forward_policy` å‚æ•°é”™è¯¯ | ğŸ”´ ä¸¥é‡ | éœ€ä¿®å¤ |
| `src_idx/dst_idx` æå–é”™è¯¯ | ğŸ”´ ä¸¥é‡ | éœ€ä¿®å¤ |
| å¥–åŠ±å…¬å¼åˆ†æ¯é”™è¯¯ | ğŸŸ¡ ä¸­ç­‰ | éœ€ä¿®å¤ |
| æ¯æ¬¡åˆ›å»ºæ–°ä¼˜åŒ–å™¨ | ğŸŸ¡ ä¸­ç­‰ | éœ€ä¿®å¤ |
| è·¯å¾„ç´¢å¼•è½¬æ¢ | ğŸŸ¡ ä¸­ç­‰ | éœ€ä¿®å¤ |

åœ¨çº¿å¾®è°ƒçš„æ€è·¯æ˜¯å¯¹çš„ï¼Œä½†å®ç°ç»†èŠ‚éœ€è¦ä¿®æ­£ã€‚ä¿®å¤åï¼Œæ‚¨çš„ç³»ç»Ÿå°±èƒ½çœŸæ­£åˆ©ç”¨ NS-3 çš„çœŸå®åé¦ˆæ¥åœ¨çº¿æ”¹è¿›æ¨¡å‹äº†ï¼